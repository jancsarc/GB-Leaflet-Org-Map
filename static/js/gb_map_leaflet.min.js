function setFeed(a,e){var n=L.control({position:"topright"});n.onAdd=function(e){var n=L.DomUtil.create("div","gb-update-feed-div");return n.innerHTML='<div class="gb-map-overlay"><div class="gb-panel gb-panel-default"><div class="gb-panel-heading"><h4>GBA Updates</h4></div><div class="gb-panel-body"><ul><li>'+a[0].name+a[0].action+a[0].modified+"</li><li>"+a[1].name+a[1].action+a[1].modified+"</li><li>"+a[2].name+a[2].action+a[2].modified+"</li><li>"+a[3].name+a[3].action+a[3].modified+"</li><li>"+a[4].name+a[4].action+a[4].modified+"</li></ul></div></div></div>",n},n.addTo(e)}function populateMap(a,e,n){var o,i,t,l=[];if(a.length<=0||null==a)$("#gb-map").hide();else{for(i=0;i<a.length;i++)if("undefined"!==a[i].latitude&&null!==a[i].latitude&&"undefined"!==a[i].longitude&&null!==a[i].longitude){var r,s=a[i].display_GBA_alliance_membership_status;r="Participating Member"==s?"<span class='map-label map-label-success'>Participating Member</span>":"Sponsor Member"==s?"<span class='map-label map-label-info'>Sponsor Member</span>":"<span class='map-label map-label-default'>"+s+"</span>";var c,d=a[i].custodian_count,p=a[i].app_count,u=null;0==d&&p>0?(c="<span class='map-label map-label-warning'>3rd Party Developer</span>",u="Orange"):(c="<span class='map-label map-label-success'>Data Custodian</span>",u="Green"),t='<div class="map-img-with-title"><img src="'+a[i].organization_thumbnail+'"/><h4>'+a[i].name+"</h4></div><ul><li>"+a[i].contact_email+"</li>"+(void 0!==p&&p>0?"<li>Number of apps: "+p+"</li>":"")+(void 0!==d&&d>0?"<li>Number of custodians: "+d+"</li>":"")+'</ul><div class="map-label-divs">'+r+c+"</div>"+(void 0!==n&&1==n?'<hr class="map-hr"> <a type="button" href="'+a[i].marketplace_url+'" class="map-btn map-btn-primary btn-block">More info</a>':"");var m=L.responsivePopup().setContent(t);o="Orange"==u?L.marker([a[i].latitude,a[i].longitude],{icon:orangeIcon}).addTo(e).bindPopup(m):L.marker([a[i].latitude,a[i].longitude],{icon:greenIcon}).addTo(e).bindPopup(m),l.push(o)}var b=L.featureGroup(l);e.fitBounds(b.getBounds())}}function initGBMap(a,e,n){if(null==a)return console.log("Please provide a valid token from the Green Button Directory Service"),void $("#gb-map").hide();null==e&&(e=!0),null==n&&(n=!0);var o=L.map("gb-map",{scrollWheelZoom:!1});L.tileLayer("https://api.mapbox.com/styles/v1/jancsarc/cj4pp0vd1asq42st6acdijnpf/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiamFuY3NhcmMiLCJhIjoiY2o0cG56cHgxMDNiZzJxbjBva213NWpzZSJ9.ggdOCnx7LPbI1sxjNFmf-A",{maxZoom:18,noWrap:!0,id:"mapbox.streets",continuousWorld:!1,maxBoundsViscosity:1,bounds:[[-90,-180],[90,180]],accessToken:"pk.eyJ1IjoiamFuY3NhcmMiLCJhIjoiY2o0cG56cHgxMDNiZzJxbjBva213NWpzZSJ9.ggdOCnx7LPbI1sxjNFmf-A"}).addTo(o);var i=L.control({position:"bottomleft"});i.onAdd=function(a){var e=L.DomUtil.create("div","info legend");return e.innerHTML='<i style="background: #cb8429;"></i> 3rd Party Developers<br><i style="background: #22ac1f;"></i> Data custodians<br>',e},i.addTo(o),o.attributionControl.setPrefix(""),$.ajax({url:"/api/current/organizations/?format=json",method:"GET",dataType:"json",crossDomain:!0,contentType:"application/json; charset=utf-8",cache:!1,beforeSend:function(e){e.setRequestHeader("Authorization","Token "+a)},success:function(a){populateMap(a,o,e)},error:function(a,e,n){$("#gb-map").hide()}}),1==n&&$.ajax({url:"/hidden-api/update-feed/",method:"GET",dataType:"json",crossDomain:!0,contentType:"application/json; charset=utf-8",cache:!1,beforeSend:function(e){e.setRequestHeader("Authorization","Token "+a)},success:function(a){setFeed(a,o)},error:function(a,e,n){$(".gb-update-feed-div").hide()}})}var greenIcon=new L.Icon({iconUrl:"https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),orangeIcon=new L.Icon({iconUrl:"https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});